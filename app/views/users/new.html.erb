<script type="text/javascript" charset="utf-8">
$(function () {
  var extractToken = function(hash) {
    var match = hash.match(/access_token=(\w+)/);
    return !!match && match[1];
  };
  var setting =
{
  'host':     "www.mapmyfitness.com"
  ,'clientId': "ye4baut4actzzzhtmhkws3acpfzaszuf"
  ,'redirect_uri': "http://localhost.mapmyapi.com:3000/user/oauth"
};
var authHost     = "https://" + setting.host;
var resourceHost = "http://" + setting.host;
var endUserAuthorizationEndpoint = authHost + "/v7.0/oauth2/uacf/authorize/";
var token = extractToken(document.location.hash);
if (token) {
  $('div.authenticated').show();
  $('span.token').text(token);
  $.ajax({
    url: resourceHost + '/me'
    , beforeSend: function (xhr) {
      xhr.setRequestHeader('Authorization', "OAuth " + token);
      xhr.setRequestHeader('Accept',        "application/json");
    }
    , success: function (response) {
      var container = $('span.user');
      if (response) {
        container.text(response.username);
      } else {
        container.text("An error occurred.");
      }
    }
  });
} else {
  $('div.authenticate').show();
  var authUrl = endUserAuthorizationEndpoint +
  "?client_id=" + setting.clientId +
  "&response_type=code" +
  "&redirect_uri=" + encodeURIComponent(setting.redirect_uri);
  $("a.connect").attr("href", authUrl);
}
});
</script>

<h1>New User!</h1>

<form action="<%= user_url %>" method="post">
  <input type="hidden" name="authenticity_token"
  value="<%= form_authenticity_token %>">
  <label for="user_email">Email</label>
  <input
  type="text"
  name="user[email]"
  value="<%= @user.email %>"
  id="user_email">

  <label for="user_password">Password</label>
  <input
  type="password"
  name="user[password]"
  id="user_password">

  <input type="submit">
</form>

<div class="authenticate hidden">
  <a class="connect" href="">Connect</a>
</div>
